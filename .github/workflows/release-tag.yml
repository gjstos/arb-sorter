name: Release & Tag ARB Sorter

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag para release (ex: v1.2.3). Se nÃ£o informado, serÃ¡ gerada automaticamente."
        required: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # NecessÃ¡rio para pegar todas as tags

      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: ğŸ“¦ Instalar dependÃªncias
        run: yarn install --immutable

      - name: ğŸ” Validar tag (se informada)
        if: github.event.inputs.tag != ''
        run: |
          TAG="${{ github.event.inputs.tag }}"

          # Verificar se segue o padrÃ£o vX.Y.Z
          if ! echo "$TAG" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' > /dev/null; then
            echo "âŒ Tag invÃ¡lida: $TAG"
            echo "A tag deve seguir o padrÃ£o vX.Y.Z (ex: v1.2.3)"
            exit 1
          fi

          # Verificar se a tag jÃ¡ existe
          if git tag | grep -Fx "$TAG" > /dev/null; then
            echo "âŒ Tag jÃ¡ existe: $TAG"
            echo "Escolha uma tag diferente ou deixe vazio para gerar automaticamente"
            exit 1
          fi

          echo "âœ… Tag vÃ¡lida: $TAG"

      - name: ğŸ·ï¸ Calcular prÃ³xima versÃ£o
        id: version
        uses: PaulHatch/semantic-version@v5.4.0
        with:
          tag_prefix: "v"

      - name: ğŸ“ Atualizar versÃ£o no package.json
        run: |
          VERSION=${{ steps.version.outputs.version }}
          echo "ğŸ”„ Atualizando versÃ£o para: $VERSION"
          npm version --no-git-tag-version "$VERSION"
          echo "âœ… VersÃ£o atualizada com sucesso!"

      - name: ğŸ“‹ Gerar changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v5
        with:
          configurationJson: |
            {
              "categories": [
                {
                  "title": "## ğŸš€ Features",
                  "labels": ["feature", "enhancement"]
                },
                {
                  "title": "## ğŸ› Bug Fixes", 
                  "labels": ["bug", "fix"]
                },
                {
                  "title": "## ğŸ”§ Maintenance",
                  "labels": ["chore", "refactor", "docs"]
                }
              ],
              "ignore_labels": ["ignore", "skip"],
              "sort": "ASC",
              "template": "#{{CHANGELOG}}\n\n<details>\n<summary>Uncategorized</summary>\n\n#{{UNCATEGORIZED}}\n</details>",
              "pr_template": "- #{{TITLE}} (#{{NUMBER}})",
              "empty_template": "- No changes"
            }
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ Criar arquivo CHANGELOG.md
        run: |
          echo "${{ steps.changelog.outputs.changelog }}" > CHANGELOG.md
          echo "âœ… Arquivo CHANGELOG.md criado com sucesso!"

      - name: ğŸ’¾ Commit e push de versÃ£o e changelog
        run: |
          echo "ğŸ”„ Configurando git..."
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          echo "ğŸ“ Adicionando arquivos..."
          git add package.json CHANGELOG.md

          echo "ğŸ’¬ Fazendo commit..."
          git commit -m "chore(release): v${{ steps.version.outputs.version }} [skip ci]"

          echo "ğŸš€ Fazendo push para main..."
          git push origin HEAD:main
          echo "âœ… Push realizado com sucesso!"

      - name: ğŸ·ï¸ Criar tag e push
        run: |
          echo "ğŸ·ï¸ Criando tag v${{ steps.version.outputs.version }}..."
          git tag v${{ steps.version.outputs.version }}

          echo "ğŸš€ Fazendo push da tag..."
          git push origin v${{ steps.version.outputs.version }}
          echo "âœ… Tag criada e enviada com sucesso!"

      - name: ğŸ“¦ Gerar .vsix
        run: |
          echo "ğŸ“¦ Gerando pacote .vsix..."
          npx vsce package
          echo "âœ… Pacote .vsix gerado com sucesso!"

      - name: ğŸš€ Criar release no GitHub
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: ${{ steps.changelog.outputs.changelog }}
          files: |
            arb-sorter-*.vsix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
